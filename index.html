<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Data Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: #0a0e27;
            color: #e4e4e7;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        header {
            background: linear-gradient(135deg, #1a1f3a 0%, #2a1f3d 100%);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(139,92,246,0.1) 0%, transparent 70%);
            animation: pulse 8s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        h1 {
            color: #a78bfa;
            font-size: 2.8em;
            margin-bottom: 10px;
            font-weight: 700;
            position: relative;
            z-index: 1;
            text-shadow: 0 0 30px rgba(167,139,250,0.5);
        }

        .subtitle {
            color: #9ca3af;
            font-size: 1.2em;
            position: relative;
            z-index: 1;
        }

        .upload-zone {
            background: linear-gradient(135deg, rgba(139,92,246,0.1) 0%, rgba(99,102,241,0.1) 100%);
            border: 3px dashed rgba(139,92,246,0.5);
            border-radius: 20px;
            padding: 60px;
            text-align: center;
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-zone:hover {
            border-color: #a78bfa;
            background: linear-gradient(135deg, rgba(139,92,246,0.15) 0%, rgba(99,102,241,0.15) 100%);
            transform: scale(1.02);
        }

        .upload-zone.dragover {
            border-color: #8b5cf6;
            background: rgba(139,92,246,0.2);
        }

        .upload-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.5em;
            color: #d1d5db;
            margin-bottom: 10px;
        }

        .upload-subtext {
            color: #9ca3af;
            font-size: 1.1em;
        }

        .toolbar {
            background: rgba(26,31,58,0.8);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.05);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Outfit', sans-serif;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(139,92,246,0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139,92,246,0.6);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: #e4e4e7;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.15);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(139,92,246,0.1) 0%, rgba(99,102,241,0.1) 100%);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid rgba(139,92,246,0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #8b5cf6, #6366f1);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(139,92,246,0.3);
            border-color: rgba(139,92,246,0.5);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            background: linear-gradient(135deg, #a78bfa 0%, #818cf8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #9ca3af;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: rgba(26,31,58,0.6);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }

        .chart-title {
            font-size: 1.3em;
            color: #e4e4e7;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .table-container {
            background: rgba(26,31,58,0.6);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }

        .search-box {
            margin-bottom: 20px;
            padding: 15px 20px;
            width: 100%;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(167,139,250,0.3);
            border-radius: 10px;
            font-size: 1em;
            color: #e4e4e7;
            font-family: 'Outfit', sans-serif;
            transition: all 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: #8b5cf6;
            background: rgba(255,255,255,0.08);
            box-shadow: 0 0 20px rgba(139,92,246,0.3);
        }

        .search-box::placeholder {
            color: #6b7280;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        th {
            background: linear-gradient(135deg, rgba(139,92,246,0.3) 0%, rgba(99,102,241,0.3) 100%);
            color: #e4e4e7;
            padding: 18px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: sticky;
            top: 0;
            border-bottom: 2px solid rgba(139,92,246,0.5);
        }

        th:first-child {
            border-top-left-radius: 10px;
        }

        th:last-child {
            border-top-right-radius: 10px;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            color: #d1d5db;
        }

        tr:hover {
            background: rgba(139,92,246,0.1);
        }

        .scroll-container {
            max-height: 600px;
            overflow-y: auto;
        }

        .scroll-container::-webkit-scrollbar {
            width: 10px;
        }

        .scroll-container::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 5px;
        }

        .scroll-container::-webkit-scrollbar-thumb {
            background: rgba(139,92,246,0.5);
            border-radius: 5px;
        }

        .scroll-container::-webkit-scrollbar-thumb:hover {
            background: rgba(139,92,246,0.7);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 2000;
            animation: slideIn 0.3s ease;
            display: none;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .notification.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .notification.info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .hidden {
            display: none !important;
        }

        .file-info {
            background: rgba(99,102,241,0.1);
            border: 1px solid rgba(99,102,241,0.3);
            padding: 15px 20px;
            border-radius: 10px;
            margin-right: auto;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-info-text {
            color: #c4b5fd;
            font-weight: 600;
        }

        input[type="file"] {
            display: none;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2em;
            }

            .toolbar {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .file-info {
                width: 100%;
            }
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
            background: rgba(139,92,246,0.2);
            color: #c4b5fd;
            border: 1px solid rgba(139,92,246,0.4);
        }

        .column-selector {
            background: rgba(26,31,58,0.8);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .column-selector h3 {
            color: #a78bfa;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .column-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .column-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .column-item label {
            color: #d1d5db;
            cursor: pointer;
            user-select: none;
        }

        .column-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Dynamic Data Dashboard</h1>
            <p class="subtitle">Upload Any CSV/Excel - Auto-Detect Columns - Visualize Instantly</p>
        </header>

        <div id="uploadSection">
            <div class="upload-zone" id="dropZone">
                <div class="upload-icon">üì§</div>
                <div class="upload-text">Drop your CSV or Excel file here</div>
                <div class="upload-subtext">or click to browse</div>
                <input type="file" id="fileInput" accept=".csv,.xlsx,.xls">
            </div>
        </div>

        <div id="dashboardSection" class="hidden">
            <div class="toolbar">
                <div class="file-info" id="fileInfo">
                    <span>üìÑ</span>
                    <span class="file-info-text" id="fileName">No file loaded</span>
                </div>
                <button class="btn btn-primary" onclick="uploadNew()">
                    <span>üì§</span> Upload New File
                </button>
                <button class="btn btn-success" onclick="exportToCSV()">
                    <span>üì•</span> Export Data
                </button>
                <button class="btn btn-secondary" onclick="refreshDashboard()">
                    <span>üîÑ</span> Refresh
                </button>
                <button class="btn btn-danger" onclick="clearData()">
                    <span>üóëÔ∏è</span> Clear Data
                </button>
            </div>

            <div class="column-selector" id="columnSelector">
                <h3>Select Columns to Visualize</h3>
                <div class="column-grid" id="columnGrid"></div>
            </div>

            <div class="stats-grid" id="statsGrid"></div>

            <div class="charts-grid" id="chartsGrid"></div>

            <div class="table-container">
                <h3 class="chart-title">Data Table</h3>
                <input type="text" id="searchBox" class="search-box" placeholder="üîç Search in any column...">
                <div class="scroll-container">
                    <table id="dataTable">
                        <thead id="tableHead"></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        let rawData = [];
        let filteredData = [];
        let columns = [];
        let selectedColumns = new Set();
        let charts = {};
        let currentFileName = '';

        // File upload handling
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            currentFileName = file.name;
            const reader = new FileReader();
            
            if (file.name.endsWith('.csv')) {
                reader.onload = (e) => {
                    const text = e.target.result;
                    parseCSV(text);
                };
                reader.readAsText(file);
            } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const csv = XLSX.utils.sheet_to_csv(firstSheet);
                    parseCSV(csv);
                };
                reader.readAsArrayBuffer(file);
            } else {
                showNotification('Please upload a CSV or Excel file', 'error');
            }
        }

        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            if (lines.length < 2) {
                showNotification('File must have at least a header row and one data row', 'error');
                return;
            }

            // Parse headers
            columns = parseCSVLine(lines[0]);
            
            // Parse data
            rawData = [];
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = parseCSVLine(lines[i]);
                    const record = {};
                    columns.forEach((col, index) => {
                        record[col] = values[index] || '';
                    });
                    rawData.push(record);
                }
            }

            // Select all columns by default
            selectedColumns = new Set(columns);
            
            // Save to localStorage
            localStorage.setItem('dashboardData', JSON.stringify(rawData));
            localStorage.setItem('dashboardColumns', JSON.stringify(columns));
            localStorage.setItem('dashboardFileName', currentFileName);
            
            initializeDashboard();
            showNotification(`Loaded ${rawData.length} records with ${columns.length} columns`, 'success');
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            
            return result;
        }

        function initializeDashboard() {
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.remove('hidden');
            document.getElementById('fileName').textContent = currentFileName;
            
            renderColumnSelector();
            updateDashboard();
        }

        function renderColumnSelector() {
            const grid = document.getElementById('columnGrid');
            grid.innerHTML = columns.map(col => `
                <div class="column-item">
                    <input type="checkbox" id="col_${col}" value="${col}" 
                           ${selectedColumns.has(col) ? 'checked' : ''} 
                           onchange="toggleColumn('${col}')">
                    <label for="col_${col}">${col}</label>
                </div>
            `).join('');
        }

        function toggleColumn(column) {
            if (selectedColumns.has(column)) {
                selectedColumns.delete(column);
            } else {
                selectedColumns.add(column);
            }
            updateDashboard();
        }

        function updateDashboard() {
            filteredData = rawData;
            renderStats();
            renderCharts();
            renderTable(filteredData);
            setupSearch();
        }

        function renderStats() {
            const statsGrid = document.getElementById('statsGrid');
            const stats = [];
            
            // Total records
            stats.push({
                label: 'Total Records',
                value: rawData.length
            });

            // Analyze selected columns for interesting stats
            selectedColumns.forEach(col => {
                const values = rawData.map(r => r[col]).filter(v => v);
                const uniqueValues = new Set(values);
                
                if (uniqueValues.size <= 20 && uniqueValues.size > 1) {
                    // Categorical data - count most common
                    const counts = {};
                    values.forEach(v => counts[v] = (counts[v] || 0) + 1);
                    const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
                    if (sorted.length > 0) {
                        stats.push({
                            label: `Most Common ${col}`,
                            value: sorted[0][0],
                            subvalue: `(${sorted[0][1]} records)`
                        });
                    }
                }
                
                // Check if numeric
                const numericValues = values.map(v => parseFloat(v)).filter(v => !isNaN(v));
                if (numericValues.length > values.length * 0.5 && numericValues.length > 0) {
                    const avg = numericValues.reduce((a, b) => a + b, 0) / numericValues.length;
                    stats.push({
                        label: `Avg ${col}`,
                        value: avg.toFixed(2)
                    });
                }
            });

            statsGrid.innerHTML = stats.slice(0, 6).map(stat => `
                <div class="stat-card">
                    <div class="stat-number">${stat.value}</div>
                    <div class="stat-label">${stat.label}</div>
                    ${stat.subvalue ? `<div style="color: #9ca3af; font-size: 0.85em; margin-top: 5px;">${stat.subvalue}</div>` : ''}
                </div>
            `).join('');
        }

        function renderCharts() {
            // Clear existing charts
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};

            const chartsGrid = document.getElementById('chartsGrid');
            chartsGrid.innerHTML = '';

            let chartIndex = 0;
            
            selectedColumns.forEach(col => {
                const values = rawData.map(r => r[col]).filter(v => v);
                const uniqueValues = new Set(values);
                
                // For categorical data with reasonable number of categories
                if (uniqueValues.size > 1 && uniqueValues.size <= 15) {
                    const counts = {};
                    values.forEach(v => counts[v] = (counts[v] || 0) + 1);
                    
                    const chartCard = document.createElement('div');
                    chartCard.className = 'chart-card';
                    chartCard.innerHTML = `
                        <h3 class="chart-title">${col} Distribution</h3>
                        <canvas id="chart_${chartIndex}"></canvas>
                    `;
                    chartsGrid.appendChild(chartCard);
                    
                    const ctx = document.getElementById(`chart_${chartIndex}`);
                    const chartType = uniqueValues.size <= 6 ? 'doughnut' : 'bar';
                    
                    charts[col] = new Chart(ctx, {
                        type: chartType,
                        data: {
                            labels: Object.keys(counts),
                            datasets: [{
                                label: col,
                                data: Object.values(counts),
                                backgroundColor: generateColors(Object.keys(counts).length),
                                borderWidth: 0,
                                borderRadius: chartType === 'bar' ? 8 : 0
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: chartType === 'doughnut' ? 'bottom' : 'top',
                                    labels: { 
                                        color: '#e4e4e7', 
                                        font: { size: 11 },
                                        boxWidth: 12
                                    }
                                }
                            },
                            scales: chartType === 'bar' ? {
                                y: {
                                    beginAtZero: true,
                                    ticks: { color: '#9ca3af' },
                                    grid: { color: 'rgba(255,255,255,0.05)' }
                                },
                                x: {
                                    ticks: { color: '#9ca3af' },
                                    grid: { display: false }
                                }
                            } : {}
                        }
                    });
                    
                    chartIndex++;
                }
                
                // For numeric data - create histogram
                const numericValues = values.map(v => parseFloat(v)).filter(v => !isNaN(v));
                if (numericValues.length > values.length * 0.7 && numericValues.length > 5) {
                    const min = Math.min(...numericValues);
                    const max = Math.max(...numericValues);
                    const range = max - min;
                    const binCount = Math.min(10, Math.ceil(Math.sqrt(numericValues.length)));
                    const binSize = range / binCount;
                    
                    const bins = Array(binCount).fill(0);
                    const binLabels = [];
                    
                    for (let i = 0; i < binCount; i++) {
                        const binStart = min + (i * binSize);
                        const binEnd = min + ((i + 1) * binSize);
                        binLabels.push(`${binStart.toFixed(1)}-${binEnd.toFixed(1)}`);
                    }
                    
                    numericValues.forEach(val => {
                        const binIndex = Math.min(Math.floor((val - min) / binSize), binCount - 1);
                        bins[binIndex]++;
                    });
                    
                    const chartCard = document.createElement('div');
                    chartCard.className = 'chart-card';
                    chartCard.innerHTML = `
                        <h3 class="chart-title">${col} Distribution</h3>
                        <canvas id="chart_${chartIndex}"></canvas>
                    `;
                    chartsGrid.appendChild(chartCard);
                    
                    const ctx = document.getElementById(`chart_${chartIndex}`);
                    charts[col + '_histogram'] = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: binLabels,
                            datasets: [{
                                label: 'Frequency',
                                data: bins,
                                backgroundColor: '#8b5cf6',
                                borderRadius: 8
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { color: '#9ca3af' },
                                    grid: { color: 'rgba(255,255,255,0.05)' }
                                },
                                x: {
                                    ticks: { color: '#9ca3af', maxRotation: 45 },
                                    grid: { display: false }
                                }
                            }
                        }
                    });
                    
                    chartIndex++;
                }
            });
        }

        function generateColors(count) {
            const colors = [
                '#8b5cf6', '#6366f1', '#ec4899', '#14b8a6', '#f59e0b', 
                '#10b981', '#ef4444', '#06b6d4', '#8b5cf6', '#f97316',
                '#a78bfa', '#818cf8', '#f472b6', '#2dd4bf', '#fbbf24'
            ];
            return colors.slice(0, count);
        }

        function renderTable(data) {
            const tableHead = document.getElementById('tableHead');
            const tableBody = document.getElementById('tableBody');
            
            // Render headers
            tableHead.innerHTML = `
                <tr>
                    ${columns.map(col => `<th>${col}</th>`).join('')}
                </tr>
            `;
            
            // Render rows
            tableBody.innerHTML = data.map(record => `
                <tr>
                    ${columns.map(col => `<td>${record[col] || '-'}</td>`).join('')}
                </tr>
            `).join('');
        }

        function setupSearch() {
            const searchBox = document.getElementById('searchBox');
            searchBox.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filtered = rawData.filter(record => {
                    return columns.some(col => 
                        String(record[col]).toLowerCase().includes(searchTerm)
                    );
                });
                renderTable(filtered);
            });
        }

        function exportToCSV() {
            const headers = columns;
            let csv = headers.map(h => `"${h}"`).join(',') + '\n';
            
            filteredData.forEach(record => {
                const row = headers.map(header => {
                    const value = record[header] || '';
                    return `"${String(value).replace(/"/g, '""')}"`;
                });
                csv += row.join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'exported_data_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
            window.URL.revokeObjectURL(url);
            
            showNotification('Data exported successfully!', 'success');
        }

        function uploadNew() {
            if (confirm('Upload a new file? Current data will be replaced.')) {
                clearData();
            }
        }

        function clearData() {
            localStorage.removeItem('dashboardData');
            localStorage.removeItem('dashboardColumns');
            localStorage.removeItem('dashboardFileName');
            rawData = [];
            columns = [];
            selectedColumns.clear();
            document.getElementById('uploadSection').classList.remove('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
            fileInput.value = '';
            showNotification('Data cleared', 'info');
        }

        function refreshDashboard() {
            updateDashboard();
            showNotification('Dashboard refreshed', 'success');
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Load saved data on startup
        window.addEventListener('DOMContentLoaded', () => {
            const savedData = localStorage.getItem('dashboardData');
            const savedColumns = localStorage.getItem('dashboardColumns');
            const savedFileName = localStorage.getItem('dashboardFileName');
            
            if (savedData && savedColumns) {
                rawData = JSON.parse(savedData);
                columns = JSON.parse(savedColumns);
                currentFileName = savedFileName || 'Previous Upload';
                selectedColumns = new Set(columns);
                initializeDashboard();
                showNotification('Loaded previous data', 'info');
            }
        });
    </script>
</body>
</html>
